<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ReadBrain â€” ì˜ì–´ ë…í•´ ì˜¤ë‹µë…¸íŠ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;700;800&family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” Deep Study Mode
   Navy base Â· Mint accent Â· Warm gold
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:        #080c14;
  --layer1:    #0d1422;
  --layer2:    #131d2e;
  --layer3:    #1a2540;
  --border:    rgba(255,255,255,0.07);
  --border2:   rgba(255,255,255,0.12);
  --mint:      #2de4b6;
  --mint-dim:  rgba(45,228,182,0.12);
  --gold:      #f5c842;
  --gold-dim:  rgba(245,200,66,0.12);
  --red:       #ff4d6a;
  --red-dim:   rgba(255,77,106,0.12);
  --text:      #dde6f5;
  --text2:     #7a8aaa;
  --text3:     #455170;
  --mono:      'JetBrains Mono', monospace;
  --sans:      'Noto Sans KR', sans-serif;
  --display:   'Syne', sans-serif;
  --r:         14px;
  --r-lg:      20px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-tap-highlight-color: transparent; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  min-height: 100dvh;
  max-width: 480px;
  margin: 0 auto;
  overflow-x: hidden;
  position: relative;
}

/* grid texture overlay */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(45,228,182,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(45,228,182,0.03) 1px, transparent 1px);
  background-size: 32px 32px;
  pointer-events: none; z-index: 0;
}

/* â”€â”€ APP SHELL â”€â”€ */
.app {
  position: relative; z-index: 1;
  display: flex; flex-direction: column;
  min-height: 100dvh;
}

/* â”€â”€ HEADER â”€â”€ */
header {
  padding: 18px 20px 14px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border);
  background: var(--layer1);
  position: sticky; top: 0; z-index: 100;
}
.logo {
  font-family: var(--display);
  font-weight: 800; font-size: 22px;
  letter-spacing: -0.5px;
  color: var(--text);
}
.logo span { color: var(--mint); }
.logo-sub {
  font-family: var(--mono);
  font-size: 9px; letter-spacing: 2px;
  color: var(--text3); margin-top: 2px;
  text-transform: uppercase;
}
.hdr-right { text-align: right; }
.streak-badge {
  font-family: var(--mono); font-size: 11px;
  color: var(--gold); background: var(--gold-dim);
  border: 1px solid rgba(245,200,66,0.2);
  padding: 3px 10px; border-radius: 30px;
}

/* â”€â”€ NAV â”€â”€ */
nav {
  display: flex; gap: 0;
  background: var(--layer1);
  border-bottom: 1px solid var(--border);
  padding: 0 8px;
  position: sticky; top: 57px; z-index: 100;
}
.tab {
  flex: 1; padding: 12px 4px;
  background: none; border: none;
  color: var(--text3); font-size: 11px;
  font-family: var(--sans); font-weight: 500;
  cursor: pointer; transition: color .2s;
  display: flex; flex-direction: column;
  align-items: center; gap: 3px;
  position: relative;
}
.tab .tab-icon { font-size: 16px; }
.tab::after {
  content: '';
  position: absolute; bottom: 0; left: 20%; right: 20%;
  height: 2px; border-radius: 2px 2px 0 0;
  background: var(--mint); opacity: 0; transition: opacity .2s;
}
.tab.active { color: var(--mint); }
.tab.active::after { opacity: 1; }
.tab-badge {
  position: absolute; top: 8px; right: 8px;
  background: var(--red); color: #fff;
  font-size: 9px; font-weight: 700; font-family: var(--mono);
  padding: 1px 5px; border-radius: 10px; min-width: 16px;
  text-align: center; display: none;
}
.tab-badge.show { display: block; }

/* â”€â”€ SECTION VIEWS â”€â”€ */
section { display: none; flex: 1; overflow-y: auto; }
section.active { display: block; }
.view-inner { padding: 18px 16px; display: flex; flex-direction: column; gap: 14px; }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: var(--layer2);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 18px;
}
.card-label {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--text3); margin-bottom: 14px;
}

/* â”€â”€ STATS ROW â”€â”€ */
.stats-row { display: flex; gap: 10px; }
.stat-box {
  flex: 1; background: var(--layer2);
  border: 1px solid var(--border);
  border-radius: var(--r); padding: 14px 10px;
  text-align: center;
}
.stat-num {
  font-family: var(--display);
  font-weight: 700; font-size: 30px;
  color: var(--mint); line-height: 1;
}
.stat-num.gold { color: var(--gold); }
.stat-num.red { color: var(--red); }
.stat-label {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 1px; color: var(--text3);
  margin-top: 5px; text-transform: uppercase;
}

/* â”€â”€ TODAY LIST â”€â”€ */
.today-empty {
  text-align: center; padding: 40px 20px;
}
.today-empty .ei { font-size: 44px; margin-bottom: 14px; }
.today-empty p { color: var(--text2); font-size: 13px; line-height: 1.8; }
.today-empty strong { color: var(--mint); }

.quiz-row {
  display: flex; align-items: center;
  padding: 13px 0; border-bottom: 1px solid var(--border);
  cursor: pointer; gap: 12px; transition: opacity .15s;
}
.quiz-row:last-child { border-bottom: none; }
.quiz-row:active { opacity: .7; }
.qr-type-dot {
  width: 8px; height: 8px; border-radius: 50%;
  flex-shrink: 0; margin-top: 2px;
}
.qr-info { flex: 1; min-width: 0; }
.qr-type-label {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 1.5px; text-transform: uppercase;
  margin-bottom: 3px;
}
.qr-question {
  font-size: 13px; color: var(--text);
  white-space: nowrap; overflow: hidden;
  text-overflow: ellipsis;
}
.qr-cycle {
  font-family: var(--mono); font-size: 9px;
  padding: 2px 7px; border-radius: 20px;
  background: var(--layer3); color: var(--text3);
  flex-shrink: 0;
}
.qr-cycle.due {
  background: var(--gold-dim); color: var(--gold);
  border: 1px solid rgba(245,200,66,0.2);
}
.qr-arrow { color: var(--text3); font-size: 14px; flex-shrink: 0; }

.start-btn {
  width: 100%; padding: 16px;
  background: var(--mint); color: #080c14;
  border: none; border-radius: var(--r);
  font-family: var(--display); font-weight: 700;
  font-size: 16px; letter-spacing: 1px;
  cursor: pointer; transition: transform .1s, opacity .1s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.start-btn:active { transform: scale(0.98); opacity: .9; }
.start-btn:disabled { opacity: .4; cursor: not-allowed; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLASHCARD QUIZ VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#quiz-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 200;
  background: var(--bg);
  flex-direction: column;
  overflow: hidden;
}
#quiz-overlay.open { display: flex; }

.qo-header {
  padding: 16px 20px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.qo-back {
  background: none; border: 1px solid var(--border2);
  color: var(--text2); border-radius: 8px;
  padding: 7px 14px; font-size: 12px; font-family: var(--sans);
  cursor: pointer;
}
.qo-counter {
  font-family: var(--mono); font-size: 12px; color: var(--text2);
}
.qo-counter strong { color: var(--mint); }

.qo-progress {
  height: 3px; background: var(--layer3); flex-shrink: 0;
}
.qo-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--mint), var(--gold));
  transition: width .4s ease; width: 0;
}

.qo-body {
  flex: 1; overflow-y: auto;
  padding: 20px 16px;
  display: flex; flex-direction: column; gap: 16px;
}

/* â”€â”€ THE CARD â”€â”€ */
.fc-container {
  perspective: 1400px;
  min-height: 280px;
  cursor: pointer;
}
.fc {
  width: 100%; min-height: 280px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform .55s cubic-bezier(.4,0,.2,1);
  border-radius: var(--r-lg);
}
.fc.flipped { transform: rotateY(180deg); }
.fc-face {
  position: absolute; inset: 0;
  backface-visibility: hidden;
  border-radius: var(--r-lg);
  padding: 24px 22px;
  display: flex; flex-direction: column;
}

/* Front face */
.fc-front {
  background: var(--layer2);
  border: 1px solid var(--border2);
}
.fc-step-badge {
  display: inline-flex; align-items: center; gap: 6px;
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 2px; text-transform: uppercase;
  padding: 4px 10px; border-radius: 20px;
  margin-bottom: 18px; align-self: flex-start;
}
.fc-question-text {
  font-size: 15px; line-height: 1.8;
  color: var(--text); flex: 1;
}
.fc-question-text em {
  color: var(--mint); font-style: normal; font-weight: 700;
  background: var(--mint-dim); padding: 0 4px; border-radius: 4px;
}
.fc-question-text strong {
  color: var(--gold); font-weight: 700;
}
.fc-tap-hint {
  margin-top: 20px; text-align: center;
  font-family: var(--mono); font-size: 10px;
  color: var(--text3); letter-spacing: 1px;
  animation: breathe 2.5s ease-in-out infinite;
}
@keyframes breathe {
  0%,100% { opacity: .3; }
  50% { opacity: .9; }
}

/* Back face */
.fc-back {
  background: linear-gradient(145deg, var(--layer2), #0d1e2a);
  border: 1px solid rgba(45,228,182,0.2);
  transform: rotateY(180deg);
}
.fc-answer-label {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 2.5px; color: var(--mint); text-transform: uppercase;
  margin-bottom: 10px;
}
.fc-answer-text {
  font-size: 20px; font-weight: 700;
  color: var(--mint); line-height: 1.5;
  flex: 0; margin-bottom: 14px;
}
.fc-divider {
  height: 1px; background: var(--border); margin: 12px 0;
}
.fc-explanation-label {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 2px; color: var(--text3); text-transform: uppercase;
  margin-bottom: 8px;
}
.fc-explanation-text {
  font-size: 13px; color: var(--text2); line-height: 1.8; flex: 1;
}
.fc-action-label {
  margin-top: 12px;
  font-family: var(--mono); font-size: 10px;
  color: var(--gold); letter-spacing: 1px;
  padding: 8px 12px;
  background: var(--gold-dim);
  border-radius: 8px;
  border-left: 2px solid var(--gold);
}

/* â”€â”€ OX BUTTONS â”€â”€ */
.ox-wrap {
  display: none; flex-direction: column; gap: 10px;
}
.ox-wrap.show { display: flex; }
.ox-row { display: flex; gap: 10px; }
.btn-o, .btn-x {
  flex: 1; padding: 17px;
  border-radius: var(--r);
  border: 1.5px solid;
  font-size: 22px; font-weight: 700;
  cursor: pointer; transition: all .15s;
  font-family: var(--mono);
}
.btn-o {
  background: var(--mint-dim);
  border-color: rgba(45,228,182,0.3);
  color: var(--mint);
}
.btn-o:active { background: var(--mint); color: #080c14; }
.btn-x {
  background: var(--red-dim);
  border-color: rgba(255,77,106,0.3);
  color: var(--red);
}
.btn-x:active { background: var(--red); color: #fff; }
.ox-note {
  text-align: center; font-family: var(--mono);
  font-size: 10px; color: var(--text3); letter-spacing: 1px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD QUIZ SECTION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.step-select { display: flex; flex-direction: column; gap: 8px; }
.step-option {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 13px 14px; border-radius: var(--r);
  background: var(--layer3); border: 1.5px solid var(--border);
  cursor: pointer; transition: border-color .2s, background .2s;
}
.step-option.selected {
  border-color: var(--mint);
  background: var(--mint-dim);
}
.step-num {
  font-family: 'Bebas Neue', var(--display);
  font-size: 28px; color: var(--mint);
  line-height: 1; flex-shrink: 0; width: 22px;
}
.step-name { font-size: 12px; font-weight: 700; color: var(--text); margin-bottom: 2px; }
.step-desc { font-size: 11px; color: var(--text2); line-height: 1.5; }

.form-group { display: flex; flex-direction: column; gap: 7px; }
.form-label {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 2px; text-transform: uppercase; color: var(--text3);
}
input[type=text], textarea {
  background: var(--layer3);
  border: 1px solid var(--border2);
  color: var(--text); border-radius: var(--r);
  padding: 12px 14px; font-size: 14px;
  font-family: var(--sans); transition: border-color .2s;
  width: 100%; resize: vertical;
}
input[type=text]:focus, textarea:focus {
  outline: none; border-color: var(--mint);
  background: #1a2a38;
}
::placeholder { color: var(--text3); }

.hint-box {
  background: var(--mint-dim); border: 1px solid rgba(45,228,182,0.2);
  border-radius: var(--r); padding: 12px 14px;
  font-size: 12px; color: var(--text2); line-height: 1.7;
}
.hint-box strong { color: var(--mint); }

.btn-add {
  width: 100%; padding: 17px;
  background: linear-gradient(135deg, var(--mint), #1ec4a0);
  color: #080c14; border: none; border-radius: var(--r);
  font-family: var(--display); font-weight: 700;
  font-size: 16px; letter-spacing: 1px;
  cursor: pointer; transition: opacity .2s, transform .1s;
}
.btn-add:active { transform: scale(.98); opacity: .9; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALL QUIZZES LIST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.all-quiz-item {
  display: flex; align-items: flex-start;
  gap: 12px; padding: 14px 0;
  border-bottom: 1px solid var(--border);
}
.all-quiz-item:last-child { border-bottom: none; }
.aqi-dot {
  width: 10px; height: 10px; border-radius: 50%;
  flex-shrink: 0; margin-top: 4px;
}
.aqi-info { flex: 1; min-width: 0; }
.aqi-type {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 1.5px; text-transform: uppercase;
  margin-bottom: 4px;
}
.aqi-q { font-size: 13px; color: var(--text); line-height: 1.5; margin-bottom: 5px; }
.aqi-meta {
  font-family: var(--mono); font-size: 10px; color: var(--text3);
}
.aqi-delete {
  background: none; border: 1px solid var(--border);
  color: var(--text3); border-radius: 6px;
  padding: 4px 8px; font-size: 11px;
  cursor: pointer; flex-shrink: 0; align-self: center;
  transition: border-color .2s, color .2s;
}
.aqi-delete:hover { border-color: var(--red); color: var(--red); }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 32px; left: 50%;
  transform: translateX(-50%) translateY(60px);
  background: var(--layer2); border: 1px solid var(--border2);
  color: var(--text); padding: 11px 22px;
  border-radius: 30px; font-size: 13px;
  font-family: var(--mono); white-space: nowrap;
  transition: transform .3s ease, opacity .3s ease;
  opacity: 0; z-index: 9999;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.ok { border-color: var(--mint); color: var(--mint); }
.toast.ng { border-color: var(--red); color: var(--red); }

/* â”€â”€ TYPE COLORS â”€â”€ */
.type-indexing   { color: #ff8c42; }
.type-targeting  { color: var(--mint); }
.type-paraphrase { color: #a855f7; }
.type-logic      { color: var(--gold); }
.type-action     { color: #38bdf8; }

.bg-indexing   { background: rgba(255,140,66,0.15); }
.bg-targeting  { background: var(--mint-dim); }
.bg-paraphrase { background: rgba(168,85,247,0.15); }
.bg-logic      { background: var(--gold-dim); }
.bg-action     { background: rgba(56,189,248,0.15); }

.dot-indexing   { background: #ff8c42; }
.dot-targeting  { background: var(--mint); }
.dot-paraphrase { background: #a855f7; }
.dot-logic      { background: var(--gold); }
.dot-action     { background: #38bdf8; }

/* â”€â”€ SECTION LABEL â”€â”€ */
.section-label {
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--text3); padding: 10px 0 4px;
}

/* scrollbar */
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--layer3); border-radius: 3px; }
</style>
</head>
<body>
<div class="app">

  <!-- â”€â”€ HEADER â”€â”€ -->
  <header>
    <div>
      <div class="logo">Read<span>Brain</span></div>
      <div class="logo-sub">Active Recall Engine</div>
    </div>
    <div class="hdr-right">
      <div class="streak-badge" id="streakBadge">ğŸ”¥ 0 ì—°ì†</div>
    </div>
  </header>

  <!-- â”€â”€ NAV â”€â”€ -->
  <nav>
    <button class="tab active" data-tab="today" onclick="switchTab('today')">
      <span class="tab-icon">ğŸ“‹</span>
      ì˜¤ëŠ˜ ë³µìŠµ
      <span class="tab-badge" id="badge-today">0</span>
    </button>
    <button class="tab" data-tab="add" onclick="switchTab('add')">
      <span class="tab-icon">ï¼‹</span>
      ì˜¤ë‹µ ì¶”ê°€
    </button>
    <button class="tab" data-tab="all" onclick="switchTab('all')">
      <span class="tab-icon">ğŸ“š</span>
      ì „ì²´ ëª©ë¡
    </button>
  </nav>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: TODAY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="sec-today" class="active">
    <div class="view-inner">
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-num" id="statTotal">0</div>
          <div class="stat-label">ì´ í€´ì¦ˆ</div>
        </div>
        <div class="stat-box">
          <div class="stat-num gold" id="statDue">0</div>
          <div class="stat-label">ì˜¤ëŠ˜ ë³µìŠµ</div>
        </div>
        <div class="stat-box">
          <div class="stat-num red" id="statStreak">0</div>
          <div class="stat-label">ì—°ì† ì •ë‹µ</div>
        </div>
      </div>

      <button class="start-btn" id="startBtn" onclick="startQuiz()" disabled>
        â–¶ ë³µìŠµ ì‹œì‘í•˜ê¸°
      </button>

      <div class="card" id="todayCard">
        <div class="card-label">ì˜¤ëŠ˜ í’€ì–´ì•¼ í•  í€´ì¦ˆ</div>
        <div id="todayList">
          <div class="today-empty">
            <div class="ei">ğŸ‰</div>
            <p>ì˜¤ëŠ˜ ë³µìŠµí•  í€´ì¦ˆê°€ ì—†ì–´ìš”!<br>
            <strong>ì˜¤ë‹µ ì¶”ê°€</strong>ì—ì„œ í€´ì¦ˆë¥¼ ë§Œë“¤ë©´<br>
            ë§ê°ê³¡ì„ ì— ë”°ë¼ 1Â·3Â·7ì¼ í›„ ìë™ ë“±ì¥í•´ìš”.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: ADD QUIZ
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="sec-add">
    <div class="view-inner">

      <div class="card">
        <div class="card-label">Step 1 â€” ì˜¤ë¥˜ ìœ í˜• ì„ íƒ</div>
        <div class="step-select" id="stepSelect">
          <div class="step-option selected" data-step="indexing" onclick="selectStep(this, 'indexing')">
            <div class="step-num type-indexing">1</div>
            <div>
              <div class="step-name">ì¸ë±ì‹± ì˜¤ë¥˜</div>
              <div class="step-desc">ì˜ˆì‹œÂ·ì„¸ë¶€ì‚¬í•­ì„ ê¸€ì˜ ì£¼ì œ/ì£¼ì¥ìœ¼ë¡œ ì°©ê°</div>
            </div>
          </div>
          <div class="step-option" data-step="targeting" onclick="selectStep(this, 'targeting')">
            <div class="step-num type-targeting">2</div>
            <div>
              <div class="step-name">íƒ€ê²ŸíŒ… ì˜¤ë¥˜</div>
              <div class="step-desc">ì§ˆë¬¸ì˜ í‚¤ì›Œë“œê°€ ë³¸ë¬¸ì— ì—†ì„ ë•Œ ìƒìœ„ê°œë…/ë™ì˜ì–´ íƒìƒ‰ ì‹¤íŒ¨</div>
            </div>
          </div>
          <div class="step-option" data-step="paraphrase" onclick="selectStep(this, 'paraphrase')">
            <div class="step-num type-paraphrase">3</div>
            <div>
              <div class="step-name">íŒ¨ëŸ¬í”„ë ˆì´ì§• ì˜¤ë¥˜</div>
              <div class="step-desc">ë³¸ë¬¸ í‘œí˜„ê³¼ ì„ ì§€ í‘œí˜„ì´ ê°™ì€ ì˜ë¯¸ì¸ë° ì—°ê²° ì‹¤íŒ¨</div>
            </div>
          </div>
          <div class="step-option" data-step="logic" onclick="selectStep(this, 'logic')">
            <div class="step-num type-logic">4</div>
            <div>
              <div class="step-name">ì„ ì§€ ë…¼ë¦¬ ì°©ì˜¤</div>
              <div class="step-desc">ê·¹ë‹¨ì–´(always/every)ì— ë‚šì´ê±°ë‚˜ ìˆ˜ëŸ‰Â·ëŒ€ìƒ ë¹„êµ ì˜¤ë¥˜</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="formCard">
        <div class="card-label">Step 2 â€” ì˜¤ë‹µ ì •ë³´ ì…ë ¥</div>
        <div id="hintBox" class="hint-box" style="margin-bottom:14px;"></div>
        <div style="display:flex; flex-direction:column; gap:12px;" id="formFields"></div>
      </div>

      <div class="card">
        <div class="card-label">Step 3 â€” í€´ì¦ˆ ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="previewBox" style="font-size:13px; color:var(--text2); line-height:1.8;">
          ìœ„ì—ì„œ ì˜¤ë¥˜ ìœ í˜•ì„ ì„ íƒí•˜ê³  ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´<br>ìë™ìœ¼ë¡œ í€´ì¦ˆê°€ ìƒì„±ë©ë‹ˆë‹¤.
        </div>
      </div>

      <button class="btn-add" id="addBtn" onclick="addQuiz()">í€´ì¦ˆ ì €ì¥í•˜ê¸°</button>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION: ALL QUIZZES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="sec-all">
    <div class="view-inner">
      <div class="card" id="allCard">
        <div class="card-label">ì „ì²´ í€´ì¦ˆ ëª©ë¡</div>
        <div id="allList">
          <div class="today-empty">
            <div class="ei">ğŸ“</div>
            <p>ì•„ì§ ì €ì¥ëœ í€´ì¦ˆê°€ ì—†ì–´ìš”.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

</div><!-- .app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FLASHCARD QUIZ OVERLAY
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="quiz-overlay">
  <div class="qo-header">
    <button class="qo-back" onclick="closeQuiz()">â† ë‹«ê¸°</button>
    <div class="qo-counter">
      <strong id="qoCurrent">1</strong> / <span id="qoTotal">5</span>
    </div>
  </div>
  <div class="qo-progress">
    <div class="qo-progress-fill" id="qoProgressFill"></div>
  </div>
  <div class="qo-body">
    <div class="fc-container" onclick="flipCard()">
      <div class="fc" id="flashcard">
        <!-- FRONT -->
        <div class="fc-face fc-front">
          <div class="fc-step-badge" id="fcBadge">TARGETING</div>
          <div class="fc-question-text" id="fcQuestion">...</div>
          <div class="fc-tap-hint">íƒ­í•´ì„œ ì •ë‹µ í™•ì¸ â†’</div>
        </div>
        <!-- BACK -->
        <div class="fc-face fc-back">
          <div class="fc-answer-label">âœ¦ ì •ë‹µ</div>
          <div class="fc-answer-text" id="fcAnswer"></div>
          <div class="fc-divider"></div>
          <div class="fc-explanation-label">í•´ì„¤ & í–‰ë™ê°•ë ¹</div>
          <div class="fc-explanation-text" id="fcExplanation"></div>
          <div class="fc-action-label" id="fcAction"></div>
        </div>
      </div>
    </div>

    <div class="ox-wrap" id="oxWrap">
      <div class="ox-row">
        <button class="btn-o" onclick="markAnswer(true)">â­• ë§ì•˜ì–´ìš”</button>
        <button class="btn-x" onclick="markAnswer(false)">âŒ í‹€ë ¸ì–´ìš”</button>
      </div>
      <div class="ox-note">ì •ë‹µ í™•ì¸ í›„ ì •ì§í•˜ê²Œ ì²´í¬!</div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LAYER â€” localStorage
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORE_KEY = 'readbrain_v2';
const STREAK_KEY = 'readbrain_streak';

function loadData() {
  try { return JSON.parse(localStorage.getItem(STORE_KEY)) || []; }
  catch { return []; }
}
function saveData(d) { localStorage.setItem(STORE_KEY, JSON.stringify(d)); }
function loadStreak() {
  try { return JSON.parse(localStorage.getItem(STREAK_KEY)) || { count: 0, lastDate: '' }; }
  catch { return { count: 0, lastDate: '' }; }
}
function saveStreak(s) { localStorage.setItem(STREAK_KEY, JSON.stringify(s)); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TYPE CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TYPES = {
  indexing: {
    label: 'INDEXING', color: 'type-indexing', bg: 'bg-indexing', dot: 'dot-indexing',
    hint: 'ì–´ë–¤ <strong>ì˜ˆì‹œ/ì„¸ë¶€ ë‚´ìš©</strong>ì„ ê¸€ì˜ ì£¼ì œë¡œ ì°©ê°í–ˆë‚˜ìš”? ì˜ˆì‹œì™€ ì£¼ì œë¥¼ êµ¬ë¶„í•˜ëŠ” í€´ì¦ˆê°€ ìƒì„±ë©ë‹ˆë‹¤.',
    fields: [
      { key: 'example', label: 'ì°©ê°í•œ ì˜ˆì‹œ ë‚´ìš© (ë³¸ë¬¸)', placeholder: 'ì˜ˆ) ì•„í”„ë¦¬ì¹´ ê¸°ì•„ ë¬¸ì œ í†µê³„' },
      { key: 'mainIdea', label: 'ì‹¤ì œ ì£¼ì œ/ì¤‘ì‹¬ ë‚´ìš©', placeholder: 'ì˜ˆ) êµ­ì œ ì›ì¡°ì˜ ë¹„íš¨ìœ¨ì„± ë¹„íŒ' },
      { key: 'passage', label: 'í•´ë‹¹ ë³¸ë¬¸ ë¬¸ì¥ (ì„ íƒ)', placeholder: 'For instance, in Africa...' },
    ],
    buildQuiz(f) {
      return {
        question: `ë‹¤ìŒ ë‚´ìš©ì€ ê¸€ì˜ <em>ì£¼ì œ</em>ì¸ê°€, ì•„ë‹ˆë©´ ë‹¨ìˆœ <em>ì˜ˆì‹œ/ì„¸ë¶€ ë‚´ìš©</em>ì¸ê°€?\n"${f.example}"`,
        answer: `ì˜ˆì‹œÂ·ì„¸ë¶€ ë‚´ìš© (ì£¼ì œ ì•„ë‹˜)`,
        explanation: `ì‹¤ì œ ì£¼ì œ: "${f.mainIdea}"\n\n"${f.example}"ëŠ” ì£¼ì œë¥¼ ë’·ë°›ì¹¨í•˜ê¸° ìœ„í•´ ì œì‹œëœ êµ¬ì²´ì  ì˜ˆì‹œì…ë‹ˆë‹¤.`,
        action: 'í–‰ë™ê°•ë ¹: ì˜ˆì‹œê°€ ë‚˜ì˜¤ë©´ â†’ "ì´ê±´ ì˜ˆì‹œì•¼, ì£¼ì œëŠ” ë” ìœ„ì— ìˆì–´" ë¼ê³  ìŠ¤ìŠ¤ë¡œ ë§í•˜ê¸°'
      };
    }
  },
  targeting: {
    label: 'TARGETING', color: 'type-targeting', bg: 'bg-targeting', dot: 'dot-targeting',
    hint: 'ì§ˆë¬¸ì˜ í‚¤ì›Œë“œê°€ ë³¸ë¬¸ì— ì—†ì„ ë•Œ ì–´ë–¤ <strong>ìƒìœ„ê°œë…Â·ë™ì˜ì–´Â·êµ¬ì²´ì˜ˆì‹œ</strong>ë¡œ ì°¾ì•„ì•¼ í–ˆë‚˜ìš”?',
    fields: [
      { key: 'qKeyword', label: 'ì§ˆë¬¸ì˜ í‚¤ì›Œë“œ (ì§€ë¬¸ì— ì—†ëŠ” ë‹¨ì–´)', placeholder: 'ì˜ˆ) Producers' },
      { key: 'textWord', label: 'ë³¸ë¬¸ì—ì„œ ì°¾ì•„ì•¼ í–ˆë˜ í‘œí˜„', placeholder: 'ì˜ˆ) Record companies' },
      { key: 'relation', label: 'ë‘ ë‹¨ì–´ì˜ ê´€ê³„', placeholder: 'ì˜ˆ) Producers = Record companiesì˜ ìƒìœ„ê°œë…' },
    ],
    buildQuiz(f) {
      return {
        question: `ì§ˆë¬¸ì˜ í‚¤ì›Œë“œ <em>${f.qKeyword}</em>ê°€ ì§€ë¬¸ì— ì—†ì„ ë•Œ,\në³¸ë¬¸ì—ì„œ ì°¾ì•„ì•¼ í•  ë‹¨ì–´/í‘œí˜„ì€?`,
        answer: f.textWord,
        explanation: `ê´€ê³„: ${f.relation}\n\nì§ˆë¬¸ì–´ â‰  ë³¸ë¬¸ í‘œí˜„ì¼ ë•Œ â†’ ìƒìœ„ê°œë…Â·í•˜ìœ„ì˜ˆì‹œÂ·ë™ì˜ì–´ë¡œ íƒ€ê²Ÿì„ ì¬ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.`,
        action: 'í–‰ë™ê°•ë ¹: í‚¤ì›Œë“œê°€ ì•ˆ ë³´ì´ë©´ â†’ "ë” ë„“ì€ ê°œë… or êµ¬ì²´ ì˜ˆì‹œëŠ”?" ìœ¼ë¡œ ì¬ìŠ¤ìº”'
      };
    }
  },
  paraphrase: {
    label: 'PARAPHRASE', color: 'type-paraphrase', bg: 'bg-paraphrase', dot: 'dot-paraphrase',
    hint: 'ë³¸ë¬¸ í‘œí˜„ê³¼ ì„ ì§€ í‘œí˜„ì´ <strong>ê°™ì€ ì˜ë¯¸</strong>ì¸ë° ì—°ê²°í•˜ì§€ ëª»í–ˆë‚˜ìš”?',
    fields: [
      { key: 'passageExpr', label: 'ë³¸ë¬¸ í‘œí˜„', placeholder: 'ì˜ˆ) soothe, inspire' },
      { key: 'choiceExpr', label: 'ì„ ì§€ í‘œí˜„ (ê°™ì€ ì˜ë¯¸)', placeholder: 'ì˜ˆ) effects on the listener' },
      { key: 'context', label: 'ì™œ ê°™ì€ ì˜ë¯¸ì¸ì§€ ì„¤ëª…', placeholder: 'ì˜ˆ) ë“£ëŠ” ì‚¬ëŒì—ê²Œ ì§„ì •Â·ì˜ê°ì„ ì£¼ëŠ” ê²ƒ = íš¨ê³¼' },
    ],
    buildQuiz(f) {
      return {
        question: `ë³¸ë¬¸ì˜ í‘œí˜„ <em>${f.passageExpr}</em>ê³¼\nê°™ì€ ì˜ë¯¸ì˜ ì„ ì§€ í‘œí˜„ì€?`,
        answer: f.choiceExpr,
        explanation: `ì—°ê²° ë…¼ë¦¬: ${f.context}\n\nì„ ì§€ëŠ” ë³¸ë¬¸ì„ ì§ì ‘ ì“°ì§€ ì•Šê³  ì˜ë¯¸ ì••ì¶•Â·ë°”ê¾¸ê¸°ë¥¼ í•©ë‹ˆë‹¤.`,
        action: 'í–‰ë™ê°•ë ¹: ì„ ì§€ ë‹¨ì–´ë¥¼ ë³¸ë¬¸ì—ì„œ ëª» ì°¾ê² ìœ¼ë©´ â†’ "ì˜ë¯¸ê°€ ê°™ì€ ë‹¤ë¥¸ í‘œí˜„ì€?" ìœ¼ë¡œ ì¬í•´ì„'
      };
    }
  },
  logic: {
    label: 'LOGIC', color: 'type-logic', bg: 'bg-logic', dot: 'dot-logic',
    hint: '<strong>ê·¹ë‹¨ì–´(always, every, only)</strong>ë‚˜ <strong>ìˆ˜ëŸ‰Â·ëŒ€ìƒ ë¹„êµ ë…¼ë¦¬</strong>ë¥¼ ì˜ëª» í•´ì„í–ˆë‚˜ìš”?',
    fields: [
      { key: 'choiceText', label: 'ì˜¤ë‹µ ì„ ì§€ ë¬¸ì¥', placeholder: 'ì˜ˆ) All music always soothes listeners.' },
      { key: 'trapWord', label: 'í•¨ì •ì´ ëœ ë‹¨ì–´ or ë…¼ë¦¬', placeholder: 'ì˜ˆ) All, always â†’ ë³¸ë¬¸ì€ "some" ìˆ˜ì¤€ë§Œ ì§€ì§€' },
      { key: 'correctLogic', label: 'ë³¸ë¬¸ì´ ì‹¤ì œë¡œ ë§í•˜ëŠ” ë²”ìœ„/ë…¼ë¦¬', placeholder: 'ì˜ˆ) ì¼ë¶€ ìŒì•…ì´ ì²­ì·¨ìì—ê²Œ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤' },
    ],
    buildQuiz(f) {
      return {
        question: `ë‹¤ìŒ ì„ ì§€ê°€ ì˜¤ë‹µì¸ ì´ìœ ë¥¼ ì„¤ëª…í•˜ì‹œì˜¤:\n<strong>"${f.choiceText}"</strong>`,
        answer: `í•¨ì •: "${f.trapWord}"`,
        explanation: `ë³¸ë¬¸ì˜ ì‹¤ì œ ë²”ìœ„: "${f.correctLogic}"\n\nì„ ì§€ê°€ ë³¸ë¬¸ë³´ë‹¤ ê³¼ì¥Â·ì¶•ì†ŒÂ·ì™œê³¡ëœ ê²½ìš° ì˜¤ë‹µì…ë‹ˆë‹¤.`,
        action: 'í–‰ë™ê°•ë ¹: always/every/only/never ë³´ì´ë©´ â†’ ë³¸ë¬¸ì—ì„œ í•´ë‹¹ ë²”ìœ„ê°€ ë’·ë°›ì¹¨ë˜ëŠ”ì§€ ì¦‰ì‹œ ê²€ì¦'
      };
    }
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPACED REPETITION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const INTERVALS = [1, 3, 7]; // days

function todayStr() {
  return new Date().toISOString().split('T')[0];
}
function addDays(dateStr, n) {
  const d = new Date(dateStr); d.setDate(d.getDate() + n);
  return d.toISOString().split('T')[0];
}
function isDue(quiz) {
  return quiz.nextReview <= todayStr();
}
function advanceCycle(quiz, correct) {
  if (!correct) {
    quiz.cycleIdx = 0;
    quiz.nextReview = addDays(todayStr(), INTERVALS[0]);
    return;
  }
  quiz.cycleIdx = (quiz.cycleIdx === undefined ? 0 : quiz.cycleIdx);
  const nextIdx = quiz.cycleIdx + 1;
  if (nextIdx < INTERVALS.length) {
    quiz.cycleIdx = nextIdx;
    quiz.nextReview = addDays(todayStr(), INTERVALS[nextIdx]);
  } else {
    quiz.cycleIdx = INTERVALS.length; // done
    quiz.nextReview = '9999-12-31'; // no more reviews
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let quizzes = loadData();
let currentStep = 'indexing';
let sessionQueue = [];
let sessionIdx = 0;
let isFlipped = false;
let streak = loadStreak();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById('sec-' + tab).classList.add('active');
  if (tab === 'today') renderToday();
  if (tab === 'all') renderAll();
  if (tab === 'add') renderForm();
}

function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast show ${type}`;
  setTimeout(() => t.className = 'toast', 2000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TODAY VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderToday() {
  const dueList = quizzes.filter(q => isDue(q) && q.nextReview !== '9999-12-31');
  const total = quizzes.filter(q => q.nextReview !== '9999-12-31').length;

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statDue').textContent = dueList.length;
  document.getElementById('statStreak').textContent = streak.count;
  document.getElementById('streakBadge').textContent = `ğŸ”¥ ${streak.count} ì—°ì†`;

  const badge = document.getElementById('badge-today');
  badge.textContent = dueList.length;
  badge.classList.toggle('show', dueList.length > 0);

  const startBtn = document.getElementById('startBtn');
  startBtn.disabled = dueList.length === 0;
  startBtn.textContent = dueList.length > 0 ? `â–¶ ë³µìŠµ ì‹œì‘ (${dueList.length}ê°œ)` : 'ì˜¤ëŠ˜ ë³µìŠµ ì™„ë£Œ! âœ“';

  const listEl = document.getElementById('todayList');
  if (dueList.length === 0) {
    listEl.innerHTML = `
      <div class="today-empty">
        <div class="ei">ğŸ‰</div>
        <p>ì˜¤ëŠ˜ ë³µìŠµí•  í€´ì¦ˆê°€ ì—†ì–´ìš”!<br>
        <strong>ì˜¤ë‹µ ì¶”ê°€</strong>ì—ì„œ í€´ì¦ˆë¥¼ ë§Œë“¤ë©´<br>
        ë§ê°ê³¡ì„ ì— ë”°ë¼ 1Â·3Â·7ì¼ í›„ ìë™ ë“±ì¥í•´ìš”.</p>
      </div>`;
    return;
  }
  listEl.innerHTML = dueList.map((q, i) => {
    const t = TYPES[q.type];
    const cycleLabel = q.cycleIdx < INTERVALS.length ? `+${INTERVALS[q.cycleIdx]}ì¼ ì£¼ê¸°` : 'ì™„ë£Œ';
    return `
      <div class="quiz-row" onclick="startSingleQuiz(${quizzes.indexOf(q)})">
        <div class="qr-type-dot ${t.dot}"></div>
        <div class="qr-info">
          <div class="qr-type-label ${t.color}">${t.label}</div>
          <div class="qr-question">${q.quiz.question.replace(/<[^>]+>/g, '').substring(0, 50)}...</div>
        </div>
        <span class="qr-cycle due">${cycleLabel}</span>
        <span class="qr-arrow">â€º</span>
      </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD QUIZ FORM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectStep(el, step) {
  document.querySelectorAll('.step-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  currentStep = step;
  renderForm();
}

function renderForm() {
  const t = TYPES[currentStep];
  document.getElementById('hintBox').innerHTML = t.hint;

  const fieldsEl = document.getElementById('formFields');
  fieldsEl.innerHTML = t.fields.map(f => `
    <div class="form-group">
      <label class="form-label">${f.label}</label>
      <input type="text" id="field_${f.key}" placeholder="${f.placeholder}"
        oninput="updatePreview()">
    </div>
  `).join('');

  updatePreview();
}

function getFieldValues() {
  const t = TYPES[currentStep];
  const vals = {};
  t.fields.forEach(f => {
    const el = document.getElementById('field_' + f.key);
    vals[f.key] = el ? el.value.trim() : '';
  });
  return vals;
}

function updatePreview() {
  const vals = getFieldValues();
  const t = TYPES[currentStep];
  const hasAll = t.fields.filter(f => !f.key.includes('passage') && !f.key.includes('context')).every(f => vals[f.key]);

  if (!hasAll) {
    document.getElementById('previewBox').innerHTML = `<span style="color:var(--text3)">í•„ë“œë¥¼ ì…ë ¥í•˜ë©´ í€´ì¦ˆ ë¯¸ë¦¬ë³´ê¸°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</span>`;
    return;
  }
  try {
    const q = t.buildQuiz(vals);
    document.getElementById('previewBox').innerHTML = `
      <div style="color:var(--text3); font-family:var(--mono); font-size:9px; letter-spacing:2px; margin-bottom:10px; text-transform:uppercase;">ì§ˆë¬¸</div>
      <div style="font-size:14px; color:var(--text); line-height:1.8; margin-bottom:12px;">${q.question.replace(/\n/g,'<br>')}</div>
      <div style="color:var(--text3); font-family:var(--mono); font-size:9px; letter-spacing:2px; margin-bottom:6px; text-transform:uppercase;">ì •ë‹µ</div>
      <div style="font-size:14px; color:var(--mint); font-weight:700;">${q.answer}</div>
    `;
  } catch(e) {
    document.getElementById('previewBox').innerHTML = `<span style="color:var(--text3)">ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>`;
  }
}

function addQuiz() {
  const vals = getFieldValues();
  const t = TYPES[currentStep];
  const required = t.fields.filter(f => !f.label.includes('ì„ íƒ'));
  const missing = required.some(f => !vals[f.key]);
  if (missing) { showToast('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'ng'); return; }

  const quiz = t.buildQuiz(vals);
  const entry = {
    id: Date.now(),
    type: currentStep,
    quiz,
    fields: vals,
    createdAt: todayStr(),
    nextReview: addDays(todayStr(), INTERVALS[0]), // 1ì¼ í›„
    cycleIdx: 0,
    history: []
  };
  quizzes.push(entry);
  saveData(quizzes);

  // clear fields
  t.fields.forEach(f => {
    const el = document.getElementById('field_' + f.key);
    if (el) el.value = '';
  });
  updatePreview();
  renderToday();
  showToast('âœ“ í€´ì¦ˆê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! 1ì¼ í›„ ë³µìŠµ ì˜ˆì •', 'ok');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALL QUIZZES VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll() {
  const el = document.getElementById('allList');
  if (quizzes.length === 0) {
    el.innerHTML = `<div class="today-empty"><div class="ei">ğŸ“</div><p>ì•„ì§ ì €ì¥ëœ í€´ì¦ˆê°€ ì—†ì–´ìš”.</p></div>`;
    return;
  }
  el.innerHTML = quizzes.map((q, i) => {
    const t = TYPES[q.type];
    const cycle = q.nextReview === '9999-12-31' ? 'ì™„ë£Œ âœ“' : `ë³µìŠµ: ${q.nextReview}`;
    const correctRate = q.history.length === 0 ? '-' :
      Math.round(q.history.filter(h=>h).length / q.history.length * 100) + '%';
    return `
      <div class="all-quiz-item">
        <div class="aqi-dot ${t.dot}"></div>
        <div class="aqi-info">
          <div class="aqi-type ${t.color}">${t.label}</div>
          <div class="aqi-q">${q.quiz.question.replace(/<[^>]+>/g,'').substring(0,60)}...</div>
          <div class="aqi-meta">${cycle} &nbsp;Â·&nbsp; ì •ë‹µë¥  ${correctRate} &nbsp;Â·&nbsp; ${q.history.length}íšŒ</div>
        </div>
        <button class="aqi-delete" onclick="deleteQuiz(${i})">ì‚­ì œ</button>
      </div>`;
  }).join('');
}

function deleteQuiz(idx) {
  if (!confirm('ì´ í€´ì¦ˆë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  quizzes.splice(idx, 1);
  saveData(quizzes);
  renderAll();
  renderToday();
  showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', '');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUIZ SESSION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startQuiz() {
  sessionQueue = quizzes
    .map((q, i) => ({ ...q, _idx: i }))
    .filter(q => isDue(q) && q.nextReview !== '9999-12-31')
    .sort(() => Math.random() - 0.5);
  if (sessionQueue.length === 0) return;
  sessionIdx = 0;
  openQuiz();
}

function startSingleQuiz(idx) {
  sessionQueue = [{ ...quizzes[idx], _idx: idx }];
  sessionIdx = 0;
  openQuiz();
}

function openQuiz() {
  document.getElementById('quiz-overlay').classList.add('open');
  loadCard();
}

function closeQuiz() {
  document.getElementById('quiz-overlay').classList.remove('open');
  document.getElementById('flashcard').classList.remove('flipped');
  document.getElementById('oxWrap').classList.remove('show');
  isFlipped = false;
  renderToday();
}

function loadCard() {
  if (sessionIdx >= sessionQueue.length) {
    // session complete
    closeQuiz();
    showToast(`ğŸ‰ ì„¸ì…˜ ì™„ë£Œ! ${sessionQueue.length}ê°œ ì™„ë£Œ`, 'ok');
    return;
  }
  const q = sessionQueue[sessionIdx];
  const t = TYPES[q.type];

  // reset card
  const card = document.getElementById('flashcard');
  card.classList.remove('flipped');
  document.getElementById('oxWrap').classList.remove('show');
  isFlipped = false;

  // fill front
  document.getElementById('fcBadge').className = `fc-step-badge ${t.bg} ${t.color}`;
  document.getElementById('fcBadge').textContent = t.label;
  document.getElementById('fcQuestion').innerHTML = q.quiz.question.replace(/\n/g, '<br>');

  // fill back
  document.getElementById('fcAnswer').textContent = q.quiz.answer;
  document.getElementById('fcExplanation').innerHTML = q.quiz.explanation.replace(/\n/g, '<br>');
  document.getElementById('fcAction').textContent = q.quiz.action;

  // counter
  document.getElementById('qoCurrent').textContent = sessionIdx + 1;
  document.getElementById('qoTotal').textContent = sessionQueue.length;
  const pct = (sessionIdx / sessionQueue.length) * 100;
  document.getElementById('qoProgressFill').style.width = pct + '%';
}

function flipCard() {
  if (isFlipped) return;
  isFlipped = true;
  document.getElementById('flashcard').classList.add('flipped');
  setTimeout(() => {
    document.getElementById('oxWrap').classList.add('show');
  }, 300);
}

function markAnswer(correct) {
  const q = sessionQueue[sessionIdx];
  const realIdx = q._idx;

  // update streak
  if (correct) {
    const today = todayStr();
    if (streak.lastDate === today) {
      streak.count += 1;
    } else if (streak.lastDate === addDays(today, -1)) {
      streak.count += 1;
      streak.lastDate = today;
    } else {
      streak.count = 1;
      streak.lastDate = today;
    }
    saveStreak(streak);
    document.getElementById('statStreak').textContent = streak.count;
    document.getElementById('streakBadge').textContent = `ğŸ”¥ ${streak.count} ì—°ì†`;
  }

  // record history & advance cycle
  quizzes[realIdx].history.push(correct);
  advanceCycle(quizzes[realIdx], correct);
  saveData(quizzes);

  showToast(correct ? 'â­• ì •ë‹µ! ì˜í–ˆì–´ìš”' : 'âŒ ì˜¤ë‹µ â€” 1ì¼ í›„ ì¬ë³µìŠµ', correct ? 'ok' : 'ng');

  // update progress bar
  const pct = ((sessionIdx + 1) / sessionQueue.length) * 100;
  document.getElementById('qoProgressFill').style.width = pct + '%';

  sessionIdx++;
  setTimeout(() => {
    document.getElementById('flashcard').classList.remove('flipped');
    document.getElementById('oxWrap').classList.remove('show');
    isFlipped = false;
    setTimeout(loadCard, 200);
  }, 400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
renderToday();
renderForm();
</script>
</body>
</html>
